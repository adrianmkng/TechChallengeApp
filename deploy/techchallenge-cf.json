{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "S3 repository for tech challenge build artifacts",

  "Parameters": {
    "BuildBucket": {
      "Type": "String",
      "Description": "Bucket name for build artifacts"
    },

    "DBUser": {
      "NoEcho": "true",
      "Type": "String",
      "Description": "Database master username",
      "MinLength": "1",
      "MaxLength": "16"
    },

    "DBPassword": {
      "NoEcho": "true",
      "Type": "String",
      "Description": "Database master password",
      "MinLength": "8",
      "MaxLength": "41"
    }
  },

  "Resources": {
    "techChallengeRepo" : {
      "Type" : "AWS::S3::Bucket",
      "Properties" : {
        "BucketName": { "Ref": "BuildBucket" },
        "PublicAccessBlockConfiguration" : {
          "BlockPublicAcls" : true,
          "BlockPublicPolicy" : true,
          "IgnorePublicAcls" : true,
          "RestrictPublicBuckets" : true
        },
        "Tags" : [ 
          {
            "Key": "Org",
            "Value": "Servian"
          },
          {
            "Key": "Candidate",
            "Value": "Adrian Ng"
          }
        ]
      }
    },

    "postgresRDS": {
      "Type": "AWS::RDS::DBInstance",
      "Properties": {
        "Engine": "postgres",
        "DBName": "app",
        "MasterUsername": { "Ref": "DBUser" },
        "DBInstanceClass": "db.t2.small",
        "AllocatedStorage": "5",
        "MasterUserPassword": { "Ref": "DBPassword" }
      }
    }

  },

  "Outputs": {
    "BucketUrl" : {
      "Description": "URL of build bucket",
      "Value": { "Fn::GetAtt": ["techChallengeRepo", "WebsiteURL"]}
    },
    "DBUrl" : {
      "Description": "RDS connection string",
      "Value": { "Fn::GetAtt": ["postgresRDS" , "Endpoint.Address"]}
    },
    "DBPort" : {
      "Description": "RDS port",
      "Value": { "Fn::GetAtt": ["postgresRDS" , "Endpoint.Port"]}
    }
  }
}

