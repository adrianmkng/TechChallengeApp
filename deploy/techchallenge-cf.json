{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Deploy tech challenge app.",

  "Parameters": {
    "DBUser": {
      "NoEcho": "true",
      "Type": "String",
      "Description": "Database master username",
      "MinLength": "1",
      "MaxLength": "16"
    },

    "DBPassword": {
      "NoEcho": "true",
      "Type": "String",
      "Description": "Database master password",
      "MinLength": "8",
      "MaxLength": "41"
    },
    "AmiId" : {
      "Type": "String",
      "Description": "AMI id for launch template"
    }
  },

  "Resources": {
    "postgresRDS": {
      "Type": "AWS::RDS::DBInstance",
      "Properties": {
        "Engine": "postgres",
        "EngineVersion" : "10.7",
        "DBName": "app",
        "MasterUsername": { "Ref": "DBUser" },
        "DBInstanceClass": "db.t2.small",
        "AllocatedStorage": "5",
        "MasterUserPassword": { "Ref": "DBPassword" }
      }
    },
    "techChallengeLaunchConfiguration":{
      "Type":"AWS::AutoScaling::LaunchConfiguration",
      "Properties":{
        "LaunchConfigurationName" : "techChallengeLaunchConfiguration",
        "ImageId":{ "Ref":"AmiId" },
        "InstanceType":"t2.micro",
        "UserData" : {
          "Fn::Base64": {
            "Fn::Join": ["", [
              "#!/usr/bin/env bash\n",

              "cat > /etc/profile.d/load_env.sh << 'EOF'\n",
              "export VTT_DbHost=${ \"Fn::GetAtt\": [\"postgresRDS\" , \"Endpoint.Address\"]}\n",
              "export VTT_DbPort=${ \"Fn::GetAtt\": [\"postgresRDS\" , \"Endpoint.Port\"]}\n",
              "EOF\n",
              "systemctl enable techchallenge\n",
              "systemctl start techchallenge\n"]
            ]
          }
        }
      }
    },

    "techChallengeASG": {
      "Type": "AWS::AutoScaling::AutoScalingGroup",
      "Properties": {
        "AutoScalingGroupName" : "techchallenge-asg",
        "AvailabilityZones" : { "Fn::GetAZs" : "" },
        "DesiredCapacity" : "1",
        "MinSize" : "1",
        "MaxSize" : "3",
        "LaunchConfigurationName" : { "Ref" : "techChallengeLaunchConfiguration" }
        }
      }
  },

  "Outputs": {
    "DBUrl" : {
      "Description": "RDS connection string",
      "Value": { "Fn::GetAtt": ["postgresRDS" , "Endpoint.Address"]}
    },
    "DBPort" : {
      "Description": "RDS port",
      "Value": { "Fn::GetAtt": ["postgresRDS" , "Endpoint.Port"]}
    }
  }
}

